<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core">

    <ui:composition template="./template.xhtml">
        <head>
            <ui:define name="title">
                <title xml:lang="de">Formel 0 - Spielen</title>
            </ui:define>
        </head>      
        <body>
            <ui:define name="navigation">
                <div id="navigation">
                    <h2 class="accessibility">Navigation</h2>
                    <ul title="Navigation">
                        <!-- TODO Links richtig setzen !-->
                        <li><h:link value="#{msg['navi.newGame']}" outcome="table" id="table" tabindex="1"/></li>
                        <li><h:link value="#{msg['navi.logout']}" outcome="index" id="index" tabindex="2"/></li>
                    </ul>
                </div>
            </ui:define>
            <ui:define name="content">
                <div id="main-area">
                    <div class="info">
                        <h2>Spielinformationen</h2>
                        <h:panelGrid id="gameInformation" columns="2"  summary="#{msg['table.infoGameHeader']}">
                            <h:outputLabel value="#{msg['table.infoGame.leading']}" 
                                           for="leading" class="label" />
                            <h:outputText id="leading" class="data" value="#{gameController.game.leader.name}" />

                            <h:outputLabel value="#{msg['table.infoGame.round']}" 
                                           for="round" class="label" />
                            <h:outputText id="round" class="data" value="#{gameController.game.round}" />

                            <h:outputLabel value="#{msg['table.infoGame.time']}" 
                                           for="time" class="label" />
                            <h:outputText id="time" class="data" value="#{gameController.game.spentTime}" />

                            <h:outputLabel value="#{msg['table.infoGame.diceRoll']}" 
                                           for="diceRoll" class="label" />
                            <h:outputText id="diceRoll" class="data" value="#{gameController.game.computer.dice.lastRoll}" />

                            <!-- Hidden fields !-->
                            <h:outputText style="display: none" value="hiddenInformation" />
                            <h:outputText style="display: none" id="humanExpectedPosition" value="#{gameController.game.player.expectedPosition}" />
                            <h:outputText style="display: none" id="humanPosition" value="#{gameController.game.player.position}" />
                            <h:outputText style="display: none" id="computerExpectedPosition" value="#{gameController.game.computer.expectedPosition}" />
                            <h:outputText style="display: none" id="computerPosition" value="#{gameController.game.computer.position}" />
                            <h:outputText style="display: none" id="gameOver" value="#{gameController.game.gameOver}" />
                        </h:panelGrid>
                        <!-- TODO delete if everything works 
                        <table summary="#{msg['table.infoGameHeader']}">
                            <tr><th id="leaderLabel" class="label">#{msg['table.infoGame.leading']}</th><td id="leader" class="data">#{gameController.game.leader.name}</td></tr>
                            <tr><th id="roundLabel" class="label">#{msg['table.infoGame.round']}</th><td id="round" class="data">#{gameController.game.round}</td></tr>
                            <tr><th id="timeLabel" class="label">#{msg['table.infoGame.time']}</th><td id="time" class="data">#{gameController.game.spentTime}</td></tr>
                            <tr><th id="computerScoreLabel" class="label">#{msg['table.infoGame.diceRoll']} <em>#{gameController.game.computer.name}</em></th><td id="computerScore" class="data">3</td></tr>
                        </table>  !-->
                        <h2>Spieler</h2>
                        <h:panelGrid id="playerInformation" columns="2" summary="#{msg['table.infoNameHeader']}" headerClass="label">
                            <h:outputLabel value="#{msg['table.infoName.player1']}" 
                                           for="player1Name" class="label" />
                            <h:outputText id="player1Name" class="data" value="#{gameController.game.player.name}" />

                            <h:outputLabel value="#{msg['table.infoName.player2']}" 
                                           for="player2Name" class="label" />
                            <h:outputText id="player2Name" class="data" value="#{gameController.game.computer.name}" />
                        </h:panelGrid>
                        <!-- TODO delete if everything works
                        <table summary="#{msg['table.infoNameHeader']}">
                            <tr><th id="player1NameLabel" class="label">#{msg['table.infoName.player1']}</th><td id="player1Name" class="data">#{gameController.game.player.name}</td></tr>
                            <tr><th id="player2NameLabel" class="label">#{msg['table.infoName.player2']}</th><td id="player2Name" class="data">#{gameController.game.computer.name}</td></tr>
                        </table> !-->    	  
                    </div>
                    <div id="field" class="field">
                        <h2 class="accessibility">#{msg['table.accessabilityGameArea']}</h2>
                        <ol id="road">
                            <li id="start_road">
                                <span class="accessibility">#{msg['table.accessabilityStartField']}</span>
                                <span id="player1">
                                    <span class="accessibility"><em>#{msg['table.accessabilityPlayer1']}</em></span>
                                </span>
                                <span id="player2">
                                    <span class="accessibility"><em>#{msg['table.accessabilityPlayer2']}</em></span>
                                </span>
                            </li>
                            <li class="empty_road" id="road_1">
                                <span class="accessibility">#{msg['table.accessabilityGameField2']}</span>
                            </li>
                            <li class="oil_road" id="road_2">
                                <span class="accessibility">#{msg['table.accessabilityGameField3']}</span>
                            </li>
                            <li class="empty_road" id="road_3">
                                <span class="accessibility">#{msg['table.accessabilityGameField4']}</span>
                            </li>
                            <li class="empty_road" id="road_4">
                                <span class="accessibility">#{msg['table.accessabilityGameField5']}</span>
                            </li>
                            <li class="oil_road" id="road_5">
                                <span class="accessibility">#{msg['table.accessabilityGameField6']}</span>
                            </li>
                            <li id="finish_road">
                                <span class="accessibility">#{msg['table.accessabilityFinishLine']}</span>
                            </li>
                        </ol>
                    </div>
                    <div id="player" class="player">
                        <h2 class="accessibility">#{msg['table.accessabilityDiceArea']}W&uuml;rfelbereich</h2>
                        <span class="accessibility">#{msg['table.accessabilityItsTurnFor']}</span><div id="currentPlayerName">#{gameController.game.player.name}</div>
                        <h:form id="diceForm">
                            <h:commandButton id="dice" type="image" 
                                             tabindex="4" 
                                             image="#{resource[gameController.game.player.dice.diceImage]}" 
                                             title="#{msg[gameController.game.player.dice.diceTitle]}" 
                                             alt="#{msg[gameController.game.player.dice.diceDescription]}" 
                                             value="Roll the Dice">
                                <f:ajax listener="#{gameController.game.rollDice()}" render=":diceForm :gameInformation :playerInformation" onevent="updateGame"/>
                            </h:commandButton>
                        </h:form>
                    </div>
                </div>
            </ui:define>
            <ui:define name="js">
                <script type="text/javascript">
                    //<![CDATA[

                    getDivId = function(num) {
                        if (num <= 0) {
                            return "#start_road";
                        }
                        if (num >= 6) {
                            return "#finish_road";
                        }
                        return "#road_" + num;
                    };
                    // call this function once before starting the animations
                    function prepareAnimation() {
                        $("#animationDone").remove();
                    }

                    // call this function once after all animations have finished
                    function completeAnimation() {
                        var div = $(document.createElement('div'));
                        div.attr('id', 'animationDone');
                        div.addClass('hide');
                        $("body").append(div);
                    }

                    //This Function gets called when the page gets reloaded
                    function updateGame() {

                        //load functions

                        function driveHuman() {
                            console.log("humanExpectedPosition: " + humanExpectedPosition + ", humanPosition: " + humanPosition);
                            $("#player1").fadeOut(speed, function() {
                                $("#player1").appendTo(humanExpectedPosition);
                                $("#player1").fadeIn(speed, checkHumanOnOilSpill());
                            });
                        }

                        function checkHumanOnOilSpill() {
                            if (humanExpectedPosition.toString() !== humanPosition.toString()) {
                                console.log("Player hit oil Spill");
                                $("#player1").fadeOut(speed, function() {
                                    $("#player1").appendTo(humanPosition);
                                    $("#player1").fadeIn(speed, driveComputer());
                                });
                            } else {
                                driveComputer();
                            }
                        }

                        function driveComputer() {
                            $("#player2").fadeOut(speed, function() {
                                $("#player2").appendTo(computerExpectedPosition);
                                $("#player2").fadeIn(speed, checkComputerOnOilSpill());
                            });
                        }

                        function checkComputerOnOilSpill() {
                            if (computerExpectedPosition.toString() !== computerPosition.toString()) {
                                console.log("Computer on Oil Spill");
                                $("#player2").fadeOut(speed, function() {
                                    $("#player2").appendTo(computerPosition);
                                    $("#player2").fadeIn(speed, completeAnimation());
                                });
                            } else {
                                completeAnimation();
                            }
                        }

                        //If it is not the first round and if the game isn't over, move the cars
                        //if ($("#gameOver").text() === "false")
                            if ($("#round").text() !== 0) {
                                var speed = 700;
                                prepareAnimation();


                                var humanExpectedPosition = getDivId($("#humanExpectedPosition").text());
                                var humanPosition = getDivId($("#humanPosition").text());
                                var computerExpectedPosition = getDivId($("#computerExpectedPosition").text());
                                var computerPosition = getDivId($("#computerPosition").text());
                                driveHuman();

                            }
                    }

                    //]]>
                </script>
            </ui:define>
        </body>
    </ui:composition>
</html>